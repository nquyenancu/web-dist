import{b4 as V,_ as W,o as q,d as M,u as E,r as P,bu as K,j as a,y as v,a8 as U,B as j,E as N,I as L,a3 as T,ad as x,n as Q,bd as O,a5 as X,aP as Y,ac as H,ba as S,bv as Z,C as ee,bw as te,bx as ae,by as re,p as ne}from"./index.cc96c54e.js";import{a as oe,b as se}from"./index.2fe840ca.js";async function*le(r,c,i){const o=new Set;async function u(){const[p,s]=await Promise.race(o);return o.delete(p),s}for(const p of c){const s=(async()=>await i(p,c))().then(f=>[s,f]);o.add(s),o.size>=r&&(yield await u())}for(;o.size;)yield await u()}const ce={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},ie=async r=>{let c=[];const i=async(o,u)=>{await new Promise(s=>{const f=n=>{console.error(n),s({})};if(o.isFile)o.file(n=>{const l=new File([n],u+n.name,{type:n.type});c.push(l),console.log(l),s({})},f);else if(o.isDirectory){const n=o.createReader(),l=()=>{n.readEntries(async h=>{h.length===0&&s({});for(let g=0;g<h.length;g++)await i(h[g],u+o.name+"/");l()},f)};l()}})};return await i(r,""),c},de=r=>({name:r.name,path:r.webkitRelativePath?r.webkitRelativePath:r.name,size:r.size,progress:0,speed:0,status:"pending"}),ue=async(r,c,i,o=!1)=>{let u=new Date().valueOf(),p=0;const s=new FormData;s.append("file",c);const f=await V.put("/fs/form",s,{headers:{"File-Path":encodeURIComponent(r),"As-Task":o,"Content-Type":"multipart/form-data",Password:W()},onUploadProgress:n=>{if(n.total){const l=n.loaded/n.total*100|0;i("progress",l);const h=new Date().valueOf(),g=(h-u)/1e3;if(g>1){const y=(n.loaded-p)/g,$=(n.total-n.loaded)/y;i("speed",y),console.log($),u=h,p=n.loaded}l===100&&i("status","backending")}}});if(f.code!==200)return new Error(f.message)},pe=[{name:"Form",upload:ue,provider:/.*/}],ge=()=>pe.filter(r=>r.provider.test(q.provider)),me=r=>{const c=M();return a(T,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${x()}`}},get children(){return[a(S,{css:{wordBreak:"break-all"},get children(){return r.path}}),a(U,{spacing:"$2",get children(){return[a(Z,{get colorScheme(){return ce[r.status]},get children(){return c(`home.upload.${r.status}`)}}),a(S,{get children(){return[ee(()=>te(r.speed)),"/s"]}})]}}),a(ae,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return r.progress},size:"sm",get children(){return a(re,{get color(){return x()},rounded:"$md"})}}),a(S,{color:"$danger10",get children(){return r.msg}})]}})},we=()=>{const r=M(),{pathname:c}=E(),[i,o]=P(!1),[u,p]=P(!1),[s,f]=P(!1),[n,l]=K({uploads:[]}),h=()=>n.uploads.every(({status:e})=>["success","error"].includes(e));let g,F;const y=async e=>{if(e.length!==0){p(!0);for(const t of e){const w=de(t);l("uploads",d=>[...d,w])}for await(const t of le(3,e,J))console.log(t)}},m=(e,t,w)=>{l("uploads",d=>d.path===e,t,w)},$=ge(),[R,G]=P($[0]),J=async e=>{const t=e.webkitRelativePath?e.webkitRelativePath:e.name;m(t,"status","uploading");const w=ne(c(),t);try{const d=await R().upload(w,e,(D,C)=>{m(t,D,C)},s());d?(m(t,"status","error"),m(t,"msg",d.message)):(m(t,"status","success"),m(t,"progress",100))}catch(d){console.error(d),m(t,"status","error"),m(t,"msg",d.message)}};return a(T,{w:"$full",pb:"$2",spacing:"$2",get children(){return a(v,{get when(){return!u()},get fallback(){return[a(U,{spacing:"$2",get children(){return[a(j,{colorScheme:"accent",onClick:()=>{l("uploads",e=>e.filter(({status:t})=>!["success","error"].includes(t))),console.log(n.uploads)},get children(){return r("home.upload.clear_done")}}),a(v,{get when(){return h()},get children(){return a(j,{onClick:()=>{p(!1)},get children(){return r("home.upload.back")}})}})]}}),a(N,{get each(){return n.uploads},children:e=>a(me,e)})]},get children(){return[a(L,{type:"file",multiple:!0,ref(e){const t=g;typeof t=="function"?t(e):g=e},display:"none",onChange:e=>{var t;y(Array.from((t=e.target.files)!=null?t:[]))}}),a(L,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){const t=F;typeof t=="function"?t(e):F=e},display:"none",onChange:e=>{var t;y(Array.from((t=e.target.files)!=null?t:[]))}}),a(T,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${i()?x():"$neutral8"}`},rounded:"$lg",onDragOver:e=>{e.preventDefault(),o(!0)},onDragLeave:()=>{o(!1)},onDrop:async e=>{var _,A,z,I;e.preventDefault(),e.stopPropagation(),o(!1);const t=[],w=Array.from((A=(_=e.dataTransfer)==null?void 0:_.items)!=null?A:[]),d=Array.from((I=(z=e.dataTransfer)==null?void 0:z.files)!=null?I:[]);let D=w.length;const C=[];for(let k=0;k<D;k++){const b=w[k].webkitGetAsEntry();b!=null&&b.isFile?t.push(d[k]):b!=null&&b.isDirectory&&C.push(b)}for(const k of C){const B=await ie(k);t.push(...B)}t.length===0&&Q.warning(r("home.upload.no_files_drag")),y(t)},spacing:"$4",h:"$56",get children(){return a(v,{get when(){return!i()},get fallback(){return a(O,{get children(){return r("home.upload.release")}})},get children(){return[a(O,{get children(){return r("home.upload.upload-tips")}}),a(X,{w:"30%",get children(){return a(Y,{get value(){return R().name},onChange:e=>{G($.find(t=>t.name===e))},get options(){return $.map(e=>({label:e.name,value:e.name}))}})}}),a(U,{spacing:"$4",get children(){return[a(H,{compact:!0,size:"xl",get["aria-label"](){return r("home.upload.upload_folder")},colorScheme:"accent",get icon(){return a(oe,{})},onClick:()=>{F.click()}}),a(H,{compact:!0,size:"xl",get["aria-label"](){return r("home.upload.upload_files")},get icon(){return a(se,{})},onClick:()=>{g.click()}})]}})]}})}})]}})}})};export{we as default};
